
//var cow = new Image();
//cow.src = "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pg0KPCEtLSBVcGxvYWRlZCB0bzogU1ZHIFJlcG8sIHd3dy5zdmdyZXBvLmNvbSwgR2VuZXJhdG9yOiBTVkcgUmVwbyBNaXhlciBUb29scyAtLT4NCjxzdmcgaGVpZ2h0PSI4MDBweCIgd2lkdGg9IjgwMHB4IiB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiANCgkgdmlld0JveD0iMCAwIDUxMS45NzggNTExLjk3OCIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8cGF0aCBzdHlsZT0iZmlsbDojRjZCQjQyOyIgZD0iTTIzNC41Miw0MjkuNTEyYy01Ljg5MSwwLTEwLjY2NC00Ljc4MS0xMC42NjQtMTAuNjcydi0xMC42NTZjMC01Ljg5LDQuNzczLTEwLjY3MSwxMC42NjQtMTAuNjcxDQoJYzUuODksMCwxMC42NjQsNC43ODEsMTAuNjY0LDEwLjY3MXYxMC42NTZDMjQ1LjE4Myw0MjQuNzMxLDI0MC40MSw0MjkuNTEyLDIzNC41Miw0MjkuNTEyeiIvPg0KPHBhdGggc3R5bGU9ImZpbGw6I0ZGQ0U1NDsiIGQ9Ik0yNzUuNjQzLDQwMC41NzZjLTIuNTQ3LTQuNDg0LTcuNTYyLTE4LjgyOC04LjUyMy00MS41OTNjLTAuMzk3LTkuNDUzLTcuNzEtMjUuNDY4LTMyLjYtMjUuNDY4DQoJYy0yNC44ODIsMC0zMi4yMDIsMTYuMDE1LTMyLjYsMjUuNDY4Yy0wLjk2MSwyMi43NjUtNS45NzcsMzcuMTA4LTguNTMxLDQxLjU5M2MtMS44NTksMi45MjEtMi4xMTcsNi40NTItMC44MDUsOS42NTUNCgljMS4zMTIsMy4yMTksNC4xOTUsNS40ODQsNy41ODUsNi4yNWMxLjA3LDAuMjUsMTEuMTA5LDIuMzU5LDM0LjM1LDIuMzU5YzIzLjI1LDAsMzMuMjgtMi4xMDksMzQuMzUtMi4zNTkNCgljMy4zODMtMC43NjYsNi4yNzMtMy4wMzEsNy41ODYtNi4yNUMyNzcuNzY4LDQwNy4wMjgsMjc3LjUwMyw0MDMuNDk3LDI3NS42NDMsNDAwLjU3NnoiLz4NCjxwYXRoIHN0eWxlPSJmaWxsOiM5NjUzNTM7IiBkPSJNNDc1LjgwNywyNzMuODQ2Yy0xMy4zMjgtMjAuMDMxLTI2Ljc5Ni0zOC41MzEtMzIuMjMzLTQ1LjkyMWMwLjQwNi01LjEyNSwwLjczNC0xNC4yMTgtMC40MjItMjYuNTMNCgljLTEuMTA5LTExLjk1My0xNS4zNzQtNDcuOTA1LTMxLjEyMy03OC40ODFjLTkuNDIyLTE4LjI4LTE4LjUtMzMuMDc3LTI2Ljk4NC00My45OThjLTEyLjA3Ny0xNS41LTIyLjU3Ni0yMi43MTgtMzMuMDYxLTIyLjcxOA0KCWMtMTUuOTUzLDAtMzEuMzExLDExLjI4MS00NS42ODUsMzMuNTYxYy01LjA0Nyw3LjgxMi05LjA0NywxNS41NzgtMTEuNzY2LDIxLjMyOGMtMzcuNzEtMTIuMTU2LTE3OS4xMTEtNTUuODEtMjY0LjY2Mi01NS44MQ0KCWMtNy4zMTIsMC0xNC4xNDgsMC4zMjgtMjAuMzEyLDAuOTY5Yy0yLjkyOSwwLjMxMi01LjYwMSwxLjgxMi03LjM4Miw0LjE1NmMtMS43ODEsMi4zMjgtMi41MTYsNS4zMTItMi4wMzEsOC4yMTlsNjMuOTk4LDM4My45ODUNCgljMC42MDksMy42NzIsMy4xMDEsNi43NjYsNi41NzgsOC4xNTVjMS4yNzMsMC41LDIuNjA5LDAuNzUsMy45MzgsMC43NWMyLjI4OSwwLDQuNTYyLTAuNzM0LDYuNDQ0LTIuMTcxbDE0OC41ODgtMTEyLjU2DQoJYzcuNjg4LTMuNzE5LDE1Ljk3Ni03LjE1NSwyMS4wMzEtOC43OTZjMzYuOTk5LDU3Ljg4OSwxMjMuMDQyLDYyLjY4NiwxNDEuNTQxLDYzLjA0NWM5LjQ1Myw1LjcwMiwzMS4xMjUsMTcuODEyLDQ0LjM0MywxNy44MTINCgljMTMuNjU1LDAsNDUuNzY0LTcuOTA2LDQ5LjM4OC04LjgxMmMyLjgxMi0wLjcwMyw1LjIxOS0yLjUxNiw2LjY1Ni01LjAzMWMwLjc5Ny0xLjM1OSwxOS4zMjctMzMuODczLDE5LjMyNy01OS4yOTUNCglDNTExLjk3NywzMzcuNTYyLDUwNy44NjgsMzIyLjAxNSw0NzUuODA3LDI3My44NDZ6Ii8+DQo8Zz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojNDM0QTU0OyIgZD0iTTM3My4zNDMsMjA1LjUyYzAsNS44OTEtNC43ODEsMTAuNjcyLTEwLjY3MSwxMC42NzJjLTUuODkxLDAtMTAuNjcyLTQuNzgxLTEwLjY3Mi0xMC42NzINCgkJYzAtNS44OSw0Ljc4MS0xMC42NzEsMTAuNjcyLTEwLjY3MUMzNjguNTYxLDE5NC44NDksMzczLjM0MywxOTkuNjMsMzczLjM0MywyMDUuNTJ6Ii8+DQoJPHBhdGggc3R5bGU9ImZpbGw6IzQzNEE1NDsiIGQ9Ik01MDEuODM3LDMxNi41NjRjLTAuMzkxLTAuNTk0LTAuNjU2LTEuMDk0LTAuNzgxLTEuNDY5di0wLjAxNg0KCQljLTguMjY1LDIuMzU5LTI5LjQ4MiwxOS43NzksNS45MjIsNTcuNDgxbDAsMGMyLjg1OS04Ljc2Niw1LTE4LjIxOSw1LTI2Ljg1OUM1MTEuOTc3LDM0MC43MDMsNTEwLjQzLDMzMi45MzcsNTAxLjgzNywzMTYuNTY0eiIvPg0KPC9nPg0KPHBhdGggc3R5bGU9ImZpbGw6I0NDRDFEOTsiIGQ9Ik00OTAuNjgxLDYwLjQ0OGMtMC4yNjYtNC4wNzgtMi44MjgtNy42NC02LjYwOS05LjE4N2MtMy43OC0xLjU0Ny04LjEyNC0wLjc5Ny0xMS4xNzEsMS45MzcNCgljLTAuMzI4LDAuMjgxLTMzLjQwNCwyOS40OTktNzkuNzk0LDM0LjM4OWMtMTAuMzQ0LDEuMDc4LTIwLjU2MiwxLjY0LTMwLjM3MywxLjY0Yy0xNC43OTcsMC0yNi4xMjUtMS4yMDMtMzUuMjE4LTIuMTcxDQoJYy01Ljk4My0wLjY0MS0xMC43MDItMS4xNDEtMTQuODU4LTEuMTQxYy0zLjA5MywwLTUuNjA4LDAuMjgxLTcuOTIxLDAuODc1Yy05LjQ4NCwyLjQyMS0xNy4wOTQsNy44MjgtMjEuOTg0LDE1LjY0DQoJYy00LjM3NSw2Ljk1My02LjIwMywxNS4zNzQtNS4xNTYsMjMuNjg3YzIuMjAzLDE3LjQ2OCwxNi4wOTQsMjkuNjcsMzMuNzgsMjkuNjdjNDEuNDM2LDAsNzYuNTQzLTQuNzM0LDEwNC4zNC0xNC4wNzcNCgljMjIuOTM3LTcuNzAzLDQxLjEwNy0xOC41NzgsNTQuMDEzLTMyLjMyN2M5LjEwOS05LjcwMywxNS42MDgtMjEuMDE1LDE4LjgxMi0zMi43MDJDNDkxLjA0MSw2Ny41NzMsNDkwLjcyOCw2MS4xNTEsNDkwLjY4MSw2MC40NDh6DQoJIi8+DQo8cGF0aCBzdHlsZT0iZmlsbDojRUQ1NTY0OyIgZD0iTTI1NS45ODgsOTkuMTk3Yy0xMi41NzgtMy43MTktMjcuMDQ2LTcuODQ0LTQyLjY2Mi0xMi4wNDZ2MjcyLjAyMWwxNi4zNjYtMTIuMzkxDQoJYzcuNjg4LTMuNzE5LDE1Ljk3Ni03LjE1NSwyMS4wMzEtOC43OTZjMS42NTYsMi41OTQsMy40MjEsNS4wNzcsNS4yNjUsNy40NjhWOTkuMTk3eiIvPg0KPHBhdGggc3R5bGU9Im9wYWNpdHk6MC4xO2VuYWJsZS1iYWNrZ3JvdW5kOm5ldyAgICA7IiBkPSJNMzMxLjk2OCwzOTIuMTA3YzI3LjA2Miw3LjU0Nyw1MS40MzYsOC43NSw2MC4yOTUsOC45MjJsOS45MzgtMTAuNjU2DQoJTDMzMS45NjgsMzkyLjEwN3oiLz4NCjwvc3ZnPg==";
var interval;
const canvas = document.getElementById("PongCanvas");
const ctx = canvas.getContext("2d");
const tileSize = 20;
const gridSize = canvas.width / tileSize;
var player1IsMoving, player1Direction, player1PaddleSpeed = 1;

var then, now, elapsed;
var fpsInterval = 1000 / 60;

let player1 = { x: 20, y: 250, width: 15, height: 100 };
let player2 = { x: 565, y: 250, width: 15, height: 100 };
let running = false;
let ball = { x: 300, y: 300, size: 15, ballspeed: 4, direction: 0 };
let score1 = 0;
let score2 = 0;

function begingame() {
    running = true;
    ball.x = 300;
    ball.y = 300;
    ball.direction = 0;
    then = window.performance.now();
    startTime = then;
    animate();
}

function drawBoard() {
    ctx.strokeStyle = "#dddddd";
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < gridSize; i++) {
        for (let j = 0; j < gridSize; j++) {
            ctx.strokeRect(i * tileSize, j * tileSize, tileSize, tileSize);
        }
    }
}

function Player1() {
    if (player1IsMoving == true) {
        if (player1Direction == "down" && player1.y + player1PaddleSpeed <= 500) {
            player1.y += player1PaddleSpeed;
            player1PaddleSpeed++;
        }
        else if (player1Direction == "up" && player1.y - player1PaddleSpeed >= 0) {
            player1.y -= player1PaddleSpeed;
            player1PaddleSpeed++;
        }
    }

    ctx.fillStyle = "green";
    ctx.fillRect(player1.x, player1.y, player1.width, player1.height);
}

function Player2() {
    if (ball.y <= player2.y) {
        player2.y -= 2;
    }
    else if (ball.y >= player2.y + player2.height) {
        player2.y += 2;
    }
    ctx.fillStyle = "blue";
    ctx.fillRect(player2.x, player2.y, player2.width, player2.height);
}

var previousBalls = [];
function moveball() {
    if (running) {
        // Check collision with Player 1's paddle
        if ((ball.x <= player1.x + player1.width) && (ball.y >= player1.y && ball.y <= player1.y + player1.height)) {
            var middle = (player1.y + player1.height / 2);
            if (ball.y >= middle) {
                ball.direction = 45;
            } else if (ball.y <= middle) {
                ball.direction = 335;
            }
        }

        // Check collision with Player 2's paddle
        if ((ball.x + ball.size >= player2.x) && (ball.y >= player2.y && ball.y <= player2.y + player2.height)) {
            var middle = (player2.y + player2.height / 2);
            if (ball.y >= middle) {
                ball.direction = 135;
            } else if (ball.y <= middle) {
                ball.direction = 225;
            }
        }

        // Check collision with top or bottom wall
        if (ball.y <= 0 || ball.y + ball.size >= canvas.height) {
            ball.direction = 360 - ball.direction; // Reflect the angle vertically
        }

        // Check if the ball hits the left wall (Player 1 loses)
        if (ball.x <= 0) {
            running = false;
            var p2 = document.getElementById("points2");
            score2++;

            p2.innerHTML = score2;
        }

        // Check if the ball hits the right wall (Player 2 loses)
        if (ball.x >= canvas.width) {
            running = false;
            var points1 = document.getElementById("points1");
            score1++;
            points1.innerHTML = score1;
        }

        // Calculate new ball position
        var radians = ball.direction * Math.PI / 180;
        var x = Math.cos(radians) * ball.ballspeed;
        var y = Math.sin(radians) * ball.ballspeed;

        //draw shadow of the ball
        for (var i = 0; i < previousBalls.length; i++) {
            let previousBall = previousBalls[i];
            ctx.fillStyle = "#80808030";
            ctx.strokeStyle = "#80808030";
            ctx.beginPath();
            ctx.arc(previousBall.x, previousBall.y, previousBall.size + 2, 0, 2 * Math.PI);
            ctx.fill();
            ctx.stroke();
        }

        ball.x += x;
        ball.y += y;

        // Update ball display
        ctx.fillStyle = "lightblue";
        ctx.strokeStyle = "blue";
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.size, 0, 2 * Math.PI);
        ctx.fill();
        ctx.stroke();
        //ctx.drawImage(flames, ball.x, ball.y, 50, 50);
        previousBalls.push({ x: ball.x, y: ball.y, size: ball.size });
        if (previousBalls.length > 5) {
            previousBalls.shift();
        }
    }
}

function updateGame() {
    drawBoard();
    moveball();
    Player1();
    Player2();
}

function animate() {
    if (!running) return;
    // request another frame
    requestAnimationFrame(animate);

    // calc elapsed time since last loop
    now = window.performance.now();
    elapsed = now - then;

    // if enough time has elapsed, draw the next frame
    if (elapsed > fpsInterval) {
        // Get ready for next frame by setting then=now, but also adjust for your
        // specified fpsInterval not being a multiple of RAF's interval (16.7ms)
        then = now - (elapsed % fpsInterval);
        updateGame();
    }
}

// create a document event listener that does keyup event
// set player1IsMoving set to false
document.addEventListener("keyup", (event) => {
    player1IsMoving = false;
    player1PaddleSpeed = 1;
});

document.addEventListener("keydown", (event) => {
    switch (event.key) {
        case "w":
            player1IsMoving = true;
            player1Direction = "up";
            break;
        case "s":
            player1IsMoving = true;
            player1Direction = "down";
            break;
    }
});

drawBoard();
Player1();